<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Оплата услуг(AJAX)</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body,
        select,
        input {
            font-family: sans-serif;
            font-size: 16px;
        }

        .mode-switch {
            display: box;
            justify-content: left;
            margin: 20px 0;
        }

        .mode-btn {
            background-color: #e0e0e0;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .mode-btn.active {
            background-color: #007bff;
            color: white;
        }

        .mode-content {
            text-align: left;
            margin-top: 20px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.5s ease, max-height 0.5s ease;
        }

        .mode-content.active {
            opacity: 1;
            max-height: 500px;
        }

        .get-ls-data-btn {
            background-color: #e0e0e0;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .get-ls-data-btn.active {
            background-color: #007bff;
            color: white;
        }

        /*       .toggle-mode-switch-btn {
            background-color: #007bff;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            height: 40px;
        }

        .toggle-mode-switch-btn:hover {
            background-color: #0056b3;
        }

        .toggle-mode-switch-btn:focus {
            outline: none;
        }
*/
        .blue-label {
            color: #007bff;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
        }

        .editable {
            background-color: #ffffcc;
        }

        .editable input {
            text-align: right;
        }
    </style>
</head>

<body>


    <form id="myForm">
        <div class="mode-switch">
            <span class="blue-label"> Поиск : </span>


            <button class="mode-btn active" id="territory-btn" data-mode="territory">По территории</button>
            <button class="mode-btn" id="access-code-btn" data-mode="access-code">По коду доступа</button>

            <div id="territory-selection" class="mode-content">
                <!-- Здесь будет содержимое для выбора "По территории" -->
                <label for="ivcBase"></label>
                <select id="ivcBase" name="ivcBase">
                    <option value="">Выберите...</option>
                </select>

            </div>

            <div id="access-code-selection" class="mode-content">
                <!-- Здесь будет содержимое для выбора "По коду доступа" -->
                <label for="accessCodeLs"></label>
                <input type="text" id="accessCodeLs" name="accessCodeLs">
                </select>

            </div>
        </div>
        <div id="ivcBaseDetails" hidden>
            <!-- <span class="blue-label">Территория : </span>
            комментарий  <button class="toggle-mode-switch-btn" id="toggleModeSwitchButton">Изменить</button>-->
            <br>
            <span id="ivcBaseName" class="blue-label"></span>
            <span id="ivcBaseCode" hidden></span>
            <span id="ivcBaseWdsl" hidden> </span>
        </div>
        <br>
        <div id="getLsData">
            <label for="Ls">Лицевой счет:</label>
            <input type="text" id="Ls" name="Ls" disabled>
            <button class="get-ls-data-btn" type="button" id="getlsDataButton" disabled>Детализация</button>
            <br>
            <p><span id="lsAddress"></span></p>
        </div>

        <div id="lsData" hidden>
            <label for="CodeSB">Коды услуг СБ</label>
            <select id="CodeSB" name="CodeSB">
                <option value="">Выберите...</option>
            </select>
        </div>
        <br>
        <label for="tablePO" class="blue-label">Задоложенность </label>
        <div style="height: 10px;"></div>
        <table id="tablePO">
            <thead>
                <tr>
                    <th>Получатель</th>
                    <th>К оплате</th>
                    <th hidden="">КодПолучателя</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr>
                    <td>ВСЕГО К ОПЛАТЕ:</td>
                    <td id="totalTablePO">350,4</td>
                    <td hidden="">0</td>
                </tr>
            </tfoot>
        </table>
        <label for="tableIPU">Приборы учёта</label>
        <div style="height: 10px;"></div>
        <table id="tableIPU">
            <thead>
                <tr>
                    <th>Прибор</th>
                    <th>Заводской номер</th>
                    <th>Предыдущее показание</th>
                    <th>Показание текущее</th>
                    <th hidden="">Код прибора в 1С</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ХВ 27040908</td>
                    <td>27040908</td>
                    <td>399</td>
                    <td><input id="pok" class="form-control" max="15" min="1" step="1" type="number"></td>
                    <td hidden="">000000035729</td>
                </tr>
            </tbody>
        </table>
    </form>

    <script>
        $(document).ready(function () {
            /*function replaceWithPlaceholder($element) {
              var prevElement = $element.prev();
              var originalElement = $element.detach();
              $('<div class="placeholder"></div>').height(originalElement.height()).insertAfter(prevElement);
              return function restoreElement() {
                $('.placeholder').replaceWith(originalElement);
              };
            }
            const $ivcBase = $('#ivcBase');
            window.restoreIvcBase = replaceWithPlaceholder($ivcBase);
            window.restoreIvcBase();*/
            //$ivcBase.show();
            // AJAX запрос для получения списка баз
            function Stage(stageName) {
                const $modeSwitch = $('.mode-switch');
                const $getlsDataButton = $('#getlsDataButton');
                const $territorySelection = $('#territory-selection');
                const $accessCodeSelection = $('#access-code-selection');
                const $ivcBase = $('#ivcBase');
                const $accessCodeLs = $('#accessCodeLs');
                const $ivcBaseDetails = $('#ivcBaseDetails');
                const $Ls = $('#Ls');
                const $getLsData = $('#getLsData');
                const $lsData = $('#lsData');
                const $Address = $('#lsAddress');


                const stages = {
                    'Инициализация': () => {
                        $ivcBase.val($ivcBase.find('option:first').val());
                        $Ls.val('');
                        $getLsData.prop('disabled', true);
                        $territorySelection.addClass('active');
                        $accessCodeSelection.removeClass('active');
                        $ivcBase.show();
                        $ivcBaseDetails.hide();
                        $Ls.show();
                        $lsData.hide();
                        $getlsDataButton.prop('disabled', true);
                        $getlsDataButton.removeClass('active');
                        $Address.hide();
                    },
                    'Выбран режим по территории': () => {
                        $territorySelection.addClass('active');
                        $accessCodeSelection.removeClass('active');
                        $territorySelection.show();
                        $accessCodeSelection.hide();
                        $ivcBase.show();
                        $ivcBaseDetails.hide();
                        $lsData.hide();
                        $Address.hide();
                        $Ls.prop('disabled', true);
                        $getLsData.prop('disabled', true);
                        $getlsDataButton.prop('disabled', true);
                        $getlsDataButton.removeClass('active');
                        $Ls.val('');
                    },
                    'Выбран режим по коду доступа': () => {
                        $accessCodeSelection.addClass('active');
                        $territorySelection.removeClass('active');
                        $accessCodeSelection.show();
                        $territorySelection.hide();
                        $accessCodeLs.show();
                        $accessCodeLs.val('970017035729-');
                        $ivcBaseDetails.hide();
                        $lsData.hide();
                        $Address.hide();
                        $Ls.prop('disabled', true);
                        $getLsData.prop('disabled', true);
                        $getlsDataButton.prop('disabled', true);
                        $getlsDataButton.removeClass('active');

                        $Ls.val('');
                    },
                    'Выбрана территория': () => {
                        $territorySelection.removeClass('active');
                        $accessCodeSelection.removeClass('active');
                        $ivcBase.hide();
                        $ivcBaseDetails.show();
                        $Ls.show();
                        $lsData.hide();
                        $Address.hide();
                        $Ls.prop('disabled', false);
                        $getLsData.prop('disabled', false);
                        $getlsDataButton.prop('disabled', false);
                        $getlsDataButton.addClass('active');
                    },
                    'Выбран код доступа': () => {
                        //$modeSwitch.prop('disabled', true);
                        $territorySelection.removeClass('active');
                        $accessCodeSelection.removeClass('active');
                        $ivcBase.hide();
                        //window.restoreIvcBase = replaceWithPlaceholder($ivcBase);
                        $ivcBaseDetails.show();
                        $Ls.show();
                        $Address.show();
                        $lsData.hide();
                        $Ls.prop('disabled', false);
                        $getLsData.prop('disabled', false);
                        $getlsDataButton.prop('disabled', false);
                        $getlsDataButton.addClass('active');
                    }
                };

                stages[stageName]();
            }

            Stage('Инициализация');

            $.ajax({
                url: 'soap.php',
                type: 'POST',
                data: { func: 'getivcBases' },
                dataType: 'json',

                success: function (data) {

                    var select = $('#ivcBase');
                    select.html(''); // Очистим список перед добавлением данных

                    select.append($('<option>', {
                        value: 0, // или другое уникальное значение
                        text: 'Выберите...'  // текст опции
                    }));

                    $.each(data, function (index, value) {
                        select.append($('<option>', {
                            value: value.code, // или другое уникальное значение
                            text: value.name  // текст опции
                        }));
                    });
                },
                error: function () {
                    alert('Ошибка при загрузке данных.');
                }
            });

            $('.mode-btn').click(function () {
                event.preventDefault(); // Отменяем стандартное поведение кнопки
                $('.mode-btn').removeClass('active'); // Убираем активный класс со всех кнопок
                $(this).addClass('active'); // Добавляем активный класс на нажатую кнопку
                if ($(this).data('mode') === 'territory') {
                    Stage('Выбран режим по территории');
                } else {
                    Stage('Выбран режим по коду доступа');
                }
            });

            /*             $('#toggleModeSwitchButton').click(function () {
                            event.preventDefault(); // Отменяем стандартное поведение кнопки
                            Stage('Инициализация');
                        }); */

            $('#ivcBase').change(function () {

                var selectedText = $('#ivcBase option:selected').text(); // Получаем текст выбранной базы 
                var selectedCode = $('#ivcBase').val(); // Получаем код выбранной базы

                if (selectedCode) {
                    $.ajax({
                        url: 'soap.php',
                        type: 'POST',
                        data: { ivcBaseCode: selectedCode }, // Передаем код базы на сервер
                        dataType: 'json',
                        success: function (data) {
                            $('#ivcBaseCode').text(data[0].ivcBaseCode);
                            $('#ivcBaseWdsl').text(data[0].ivcBaseWdsl);
                            $('#ivcBaseName').text(data[0].ivcBaseName);
                            Stage('Выбрана территория');
                        },
                        error: function () {
                            alert('Ошибка при получении данных.');
                        }
                    });
                } else {
                    alert('Пожалуйста, выберите территорию.');
                }
            });

            $('#accessCodeLs').change(function () {
                var accessCodeLs = $('#accessCodeLs').val(); // Получаем код доступа ЛС
                if (accessCodeLs) {
                    $.ajax({
                        url: 'soap.php',
                        type: 'POST',
                        data: {
                            accessCodeLs: accessCodeLs,
                            func: 'getByaccessCodeLs',
                        }, // Передаем код доступа ЛС на сервер
                        dataType: 'json',
                        success: function (data) {
                            $('#ivcBaseCode').text(data['Реквизиты'].ivcBaseCode);
                            $('#ivcBaseWdsl').text(data['Реквизиты'].ivcBaseWdsl);
                            $('#ivcBaseName').text(data['Реквизиты'].ivcBaseName);
                            $('#Ls').val(data['Реквизиты'].Ls);
                            $('#lsAddress').text(data['Реквизиты'].Address);
                            Stage('Выбран код доступа');

                        },
                        error: function () {
                            alert('Ошибка при получении данных.');
                        }
                    });
                } else {
                    alert('Пожалуйста, выберите код доступа.');
                }
            });

            // Обработчик нажатия на кнопку "Найти ЛС"
            $('#getlsDataButton').click(function () {
                var Ls = $('#Ls').val(); // Получаем введенный ЛС
                var ivcBaseWdsl = $('#ivcBaseWdsl').text(); // Получаем континент выбранной базы
                var ivcBaseCode = $('#ivcBaseCode').text();
                if (Ls) {
                    $.ajax({
                        url: 'soap.php',
                        type: 'POST',
                        data: {
                            ivcBaseCode: ivcBaseCode,
                            ivcBaseWdsl: ivcBaseWdsl,
                            codeSB: '',
                            Ls: Ls,
                            func: 'getLsData'
                        },
                        dataType: 'json',
                        success: function (data) {
                            $('#lsAddress').text(data['ДанныеЛС']['АдресЛС']);
                            $('#lsData').show(); // Показываем блок с деталями ЛС
                            var select = $('#CodeSB');
                            select.html(''); // Очистим список перед добавлением данных
                            $.each(data['ДанныеЛС']['КодыСБ'], function (index, value) {
                                select.append($('<option>', {
                                    value: index, // или другое уникальное значение
                                    text: value  // текст опции
                                }));
                            });
                            var tablePO = $('#tablePO');
                            tablePO.find('tbody').empty();
                            $.each(data['ДанныеЛС']['ПолучателиСБ'], function (index, value) {
                                var row = $('<tr>');
                                row.append($('<td>').text(value.Получатель));
                                var editableCell = $('<td class="editable">');
                                editableCell.append($('<input type="text" value="' + value.Остаток + '">'));
                                row.append(editableCell);
                                row.append($('<td hidden="">').text(value.КодПолучателя));
                                tablePO.find('tbody').append(row);
                            });

                        },
                        error: function () {
                            alert('Ошибка при получении данных.');
                        }
                    });
                } else {
                    alert('Пожалуйста, введите ЛС.');
                }
            });
            //при изменении CodeSB
            $('#CodeSB').change(function () {
                var Ls = $('#Ls').val(); // Получаем введенный ЛС
                var ivcBaseWdsl = $('#ivcBaseWdsl').text(); // Получаем континент выбранной базы
                var ivcBaseCode = $('#ivcBaseCode').text();
                var codeSB = $('#CodeSB option:selected').text();
                if (Ls) {
                    $.ajax({
                        url: 'soap.php',
                        type: 'POST',
                        data: {
                            ivcBaseCode: ivcBaseCode,
                            ivcBaseWdsl: ivcBaseWdsl,
                            codeSB: codeSB,
                            Ls: Ls,
                            func: 'getLsData'
                        },
                        dataType: 'json',
                        success: function (data) {
                            // $('#lsAddress').text(data['ДанныеЛС']['АдресЛС']);
                            $('#lsData').show(); // Показываем блок с деталями ЛС
                            /*                           var select = $('#CodeSB');
                                                      select.html(''); // Очистим список перед добавлением данных
                                                      $.each(data['ДанныеЛС']['КодыСБ'], function (index, value) {
                                                          select.append($('<option>', {
                                                              value: index, // или другое уникальное значение
                                                              text: value  // текст опции
                                                          }));
                                                      }); */
                            var tablePO = $('#tablePO');
                            tablePO.find('tbody').empty();
                            $.each(data['ДанныеЛС']['ПолучателиСБ'], function (index, value) {
                                var row = $('<tr>');
                                row.append($('<td>').text(value.Получатель));
                                var editableCell = $('<td class="editable">');
                                editableCell.append($('<input type="text" value="' + value.Остаток + '">'));
                                row.append(editableCell);
                                row.append($('<td>').text(value.КодПолучателя));
                                tablePO.find('tbody').append(row);
                            });

                        },
                        error: function () {
                            alert('Ошибка при получении данных.');
                        }
                    });
                } else {
                    alert('Пожалуйста, введите ЛС.');
                }
            });
        });
    </script>
</body>

</html>